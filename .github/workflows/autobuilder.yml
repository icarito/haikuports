name: Build HaikuPorts packages

on:
  workflow_dispatch:
  push:
    branches: [ main, master, development ] # Adjust as per your repository's default branches
  pull_request:
    branches: [ main, master, development ] # Adjust as per your repository's default branches

jobs:
  prepare-build:
    runs-on: ubuntu-latest
    outputs:
      changed_recipes_json: ${{ steps.detect-changes.outputs.changed_recipes_json }}
      has_changed_recipes: ${{ steps.detect-changes.outputs.has_changed_recipes }}
    steps:
      - name: Checkout HaikuPorts repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Python for HaikuPorter
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install HaikuPorter
        run: |
          git clone https://github.com/haikuports/haikuporter.git ~/haikuporter
          sudo ln -s "$HOME/haikuporter/haikuporter" /usr/local/bin/haikuporter
          echo "HaikuPorter installed. Version:"
          haikuporter --version
        shell: bash

      - name: Set up HaikuPorter configuration
        run: |
          echo "TREE_PATH=\"${{ github.workspace }}\"" > "${{ github.workspace }}/haikuports.conf"
          echo "PACKAGER=\"CI Builder <ci@example.com>\"" >> "${{ github.workspace }}/haikuports.conf"
          echo "TARGET_ARCHITECTURE=\"x86_64\"" >> "${{ github.workspace }}/haikuports.conf"
          echo "HaikuPorter configuration created at ${{ github.workspace }}/haikuports.conf:"
          cat "${{ github.workspace }}/haikuports.conf"
        shell: bash

      - name: Download Haiku Licenses
        run: |
          wget https://github.com/waddlesplash/haiku-licenses/archive/master.zip -O haiku-licenses.zip
          unzip -q haiku-licenses.zip
          echo "Haiku Licenses downloaded and unzipped. Found directories:"
          ls -d ${{ github.workspace }}/haiku-licenses-*/ # Verify directory name relative to workspace
        shell: bash

      - name: Detect modified recipes
        id: detect-changes
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          GIT_PRIMARY_BRANCH_REF=""
          if git rev-parse --verify origin/main >/dev/null 2>&1; then
            GIT_PRIMARY_BRANCH_REF="origin/main"
          elif git rev-parse --verify origin/master >/dev/null 2>&1; then
            GIT_PRIMARY_BRANCH_REF="origin/master"
          fi

          if [ -z "$GIT_PRIMARY_BRANCH_REF" ]; then
            echo "::warning::No main or master branch found at origin to compare against. Assuming all recipes need checking."
            CHANGED_RECIPES=$(find . -name '*.recipe' -printf '%h\n' | sed 's|^\./||' | sort -u)
            echo "build_all_flag=true" >> $GITHUB_OUTPUT 
          else
            echo "Primary branch for comparison: $GIT_PRIMARY_BRANCH_REF"
            if [ "$GITHUB_EVENT_NAME" == "pull_request" ]; then
              TARGET_REF="origin/$GITHUB_BASE_REF"
              git fetch origin "$GITHUB_BASE_REF" --depth=1
              MERGE_BASE=$(git merge-base HEAD "$TARGET_REF")
              echo "Pull Request: Diffing from merge base $MERGE_BASE to HEAD ($GITHUB_SHA)"
              CHANGED_RECIPES=$(git diff --name-only "$MERGE_BASE" HEAD -- '*/*.recipe' | sed 's|/[^/]*\.recipe$||g' | sort -u)
            else
              echo "Push/Manual Trigger: Diffing from $GIT_PRIMARY_BRANCH_REF to HEAD ($GITHUB_SHA)"
              CHANGED_RECIPES=$(git diff --name-only "$GIT_PRIMARY_BRANCH_REF...HEAD" -- '*/*.recipe' | sed 's|/[^/]*\.recipe$||g' | sort -u)
            fi
            echo "build_all_flag=false" >> $GITHUB_OUTPUT
          fi
          CHANGED_RECIPES=$(echo "$CHANGED_RECIPES" | sed '/^$/d')

          if [ -z "$CHANGED_RECIPES" ]; then
            echo "No recipes changed."
            echo "changed_recipes_json=[]" >> $GITHUB_OUTPUT
            echo "has_changed_recipes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed recipes found:"
            echo "$CHANGED_RECIPES"
            CHANGED_RECIPES_JSON=$(echo "$CHANGED_RECIPES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "changed_recipes_json=$CHANGED_RECIPES_JSON" >> $GITHUB_OUTPUT
            echo "has_changed_recipes=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Update Repository and Stage Dependency Infos
        id: generate-deps
        if: steps.detect-changes.outputs.has_changed_recipes == 'true'
        run: |
          echo "Updating HaikuPorter repository to generate/update all .DependencyInfo files..."
          # Dynamically find the unzipped license directory name relative to workspace
          LICENSES_DIR_NAME=$(ls -d ${{ github.workspace }}/haiku-licenses-*/ | head -n 1 | xargs basename)
          echo "Using licenses directory: $LICENSES_DIR_NAME at ${{ github.workspace }}/$LICENSES_DIR_NAME"

          haikuporter --config="${{ github.workspace }}/haikuports.conf"                     --licenses="${{ github.workspace }}/$LICENSES_DIR_NAME"                     --repository-update

          echo "Checking contents of changed recipe directories after --repository-update:"
          CHECK_CHANGED_RECIPES_JSON='${{ steps.detect-changes.outputs.changed_recipes_json }}'
          if [ "$CHECK_CHANGED_RECIPES_JSON" == "[]" ] || [ -z "$CHECK_CHANGED_RECIPES_JSON" ]; then
            echo "No changed recipes were detected by the previous step."
          else
            echo "$CHECK_CHANGED_RECIPES_JSON" | jq -r '.[]' | while read recipe_path_to_check; do
              if [ -n "$recipe_path_to_check" ]; then
                CHECK_DIR="${{ github.workspace }}/$recipe_path_to_check"
                if [ -d "$CHECK_DIR" ]; then
                  echo "Listing contents of $CHECK_DIR:"
                  ls -la "$CHECK_DIR"
                else
                  echo "::warning::Directory not found for checking: $CHECK_DIR"
                fi
              fi
            done
          fi

          echo "Collecting .DependencyInfo files for specifically changed recipes..."
          mkdir -p dependency-infos # This is the staging directory for caching

          CHANGED_RECIPES_JSON='${{ steps.detect-changes.outputs.changed_recipes_json }}'
          if [ "$CHANGED_RECIPES_JSON" == "[]" ] || [ -z "$CHANGED_RECIPES_JSON" ]; then
            echo "No changed recipes list provided by detect-changes step, nothing to collect for cache."
          else
            echo "$CHANGED_RECIPES_JSON" | jq -r '.[]' | while read recipe_path; do
              if [ -n "$recipe_path" ]; then
                SOURCE_RECIPE_DIR="${{ github.workspace }}/$recipe_path"
                TARGET_CACHE_SUBDIR="dependency-infos/$recipe_path" # Staging subdir for this recipe's deps

                echo "Staging .DependencyInfo files from $SOURCE_RECIPE_DIR for recipe $recipe_path"
                if [ -d "$SOURCE_RECIPE_DIR" ]; then
                  mkdir -p "$TARGET_CACHE_SUBDIR"
                  # Copy .DependencyInfo files from the main tree (updated by --repository-update)
                  # to the staging area for caching.
                  # Use a subshell for find to avoid error if no files found.
                  (find "$SOURCE_RECIPE_DIR" -maxdepth 1 -name "*.DependencyInfo" -print -exec cp {} "$TARGET_CACHE_SUBDIR/" \;)
                  if [ "$(ls -A $TARGET_CACHE_SUBDIR 2>/dev/null)" ]; then
                     echo "Successfully staged .DependencyInfo files from $SOURCE_RECIPE_DIR to $TARGET_CACHE_SUBDIR"
                  else
                     echo "No .DependencyInfo files found or copied from $SOURCE_RECIPE_DIR for $recipe_path"
                  fi
                else
                  echo "::warning::Source recipe directory not found: $SOURCE_RECIPE_DIR for changed recipe $recipe_path. Cannot stage .DependencyInfo files."
                fi
              fi
            done
          fi
          echo "Listing content of dependency-infos (staged for cache):"
          ls -R dependency-infos
        shell: bash

      - name: Save changed recipes list to a file for caching
        if: steps.detect-changes.outputs.has_changed_recipes == 'true'
        run: |
          echo '${{ steps.detect-changes.outputs.changed_recipes_json }}' > changed_recipes_list.json
          echo "Saved changed recipes JSON to changed_recipes_list.json for caching."
        shell: bash
        
      - name: Cache .DependencyInfo files and changed recipes list
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            dependency-infos
            changed_recipes_list.json
          key: ${{ runner.os }}-haiku-deps-${{ github.sha }}
